<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="keywords" content="">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport"
      content="width=device-width, initial-scale=1">
<title>历史记录</title>

<!-- Set render engine for 360 browser -->
<meta name="renderer" content="webkit">

<link rel="icon" type="image/png" href="../favicon.ico">

<!-- No Baidu Siteapp-->
<meta http-equiv="Cache-Control" content="no-siteapp"/>

<link rel="stylesheet" href="../shared/amazeui.min.css">
<link rel="stylesheet" href="css/common.css">
<script src="../shared/jquery.min.js"></script>
<script src="../shared/amazeui.min.js"></script>
<script src="../shared/handlebars.min.js"></script>
<script src="../shared/layer/layer.js"></script>
<script src="../shared/common.js"></script>
<script src="../shared/jweixin-1.2.0.min.js"></script>
<script src="../shared/vue.js"></script>
    <link rel="stylesheet" href="css/qingjia_his.css">
    <link rel="stylesheet" href="css/pagi.css">
</head>
<body>
<div id="everything">
    <img src="../shared/img/history.png" alt="historyicon" id="hisicon">
    <h1 class="sometitle">请假历史记录2</h1>
    <p class="subtitle" id="plzclick"></p>
    <hr>
    <div id="histable">
        <!-- ajax here -->
    </div>
    <div class="pagi" id="pagi">
    <div class="pagi-first"><i class="am-icon-angle-double-left"></i></div>
    <div class="pagi-prev"><i class="am-icon-angle-left"></i></div>
    <div class="pagi-cur">1</div>
    <div class="pagi-next"><i class="am-icon-angle-right"></i></div>
    <div class="pagi-last"><i class="am-icon-angle-double-right"></i></div>
</div>
    <div id="hisdetail" class="detail">
        <!-- ajax here -->
    </div>
</div>

<script type="text/x-handlebars-template" id="handlebars-template-histable">
    {{#each data}}
        <div class="record" data-index="{{@index}}">
            <div class="record-status" data-status="{{status}}"><span>已通过</span></div>
            <div class="record-bar"></div>
            <div class="record-duration">
                {{begin_time}} ~ {{end_time}}
            </div>
        </div>
    {{else}}
        <p class="record-none">你好像没有请过假</p>
    {{/each}}
</script>

<script type="text/x-handlebars-template" id="handlebars-template-hisdetail">
    <p class="detail-label">你尝试在这段时间请假</p>
    <p class="detail-content">{{begin_time}} ~ {{end_time}}</p>
    <p class="detail-label">你的理由是</p>
    <p class="detail-content" style="text-align: justify;">{{leave_reason}}</p>
    {{#if is_leave}}
        <p class="detail-label">你说要去</p>
        <p class="detail-content">{{destination}}</p>
    {{/if}}
    <p class="detail-label">辅导员</p>
    <p class="detail-content" id="detail-status"></p>
    {{#if auth_reason}}
        <p class="detail-label">他（她）说</p>
        <p class="detail-content" style="text-align: justify;">{{auth_reason}}</p>
    {{/if}}
    <div class="detail-btngroup">
        <button onclick="backToTable()" class="am-btn am-btn-secondary">返回列表</button>
        <!-- <button onclick="ajaxCancelRequest({{id}})" class="am-btn am-btn-default detail-cancel">撤回申请</button> -->
    </div>
</script>

<!-- <script src="js/qingjia_his.js?sbwx=sbsbsbsbsbbsbss"></script> -->
<script>
    $(document).ready(function() {
        ajaxGetHistory('1');
    });

    function ajaxGetHistory(page) {
        $.ajax({
            url: '/leave/wx/getLeaveHistory',
            data: {
                page: page
            },
            success: function (data) {
                if(data.status == 200){
                    alert('1')
                    deployHisTable(data.data);
                    deployPagi(data.data, ajaxGetHistory);
                    layer.close(loader);
                }
            }
        });
    }

    function ajaxCancelRequest(id) {
        $('.detail-cancel').html(__SPINNER__)
            .attr('disabled', true);
        $.ajax({
            url: '/cancel/' + id,
            success: function (data) {
                $('.detail-cancel').html('撤回申请')
                    .attr('disabled', false);
                if(data.status == 200){
                    dialog.success('撤回成功', location.href, 1500);
                }
            }
        });
    }

    function deployHisTable(data) {
        var source = $('#handlebars-template-histable').html();
        var template = Handlebars.compile(source);
        $('#histable').html(template(data));
        if (data.data.length > 0) {
            $('#plzclick').text('点击查看详情');
        }
        $('#histable .record-status').each(function() {
            switch($(this).attr('data-status')) {
                case '2':
                    $(this).find('span').text('已通过').css('color', '#5cb85c');
                    break;
                case '1':
                    $(this).find('span').text('待审核').css('color', '#99979c');
                    break;
                case '3':
                    $(this).find('span').text('未通过').css('color', '#d9534f');
                    break;
            }
        });
        $('#histable .record').on('click', function() {
            deployHisDetail(data.data[$(this).attr('data-index')]);
            $('#pagi').hide();
        });
        $('#histable').fadeIn(200);
    }

    function deployHisDetail(data) {
        var source = $('#handlebars-template-hisdetail').html();
        var template = Handlebars.compile(source);
        $('#hisdetail').html(template(data));
        $('#plzclick').text('');
        $('#histable').hide();
        switch(data.status) {
            case 2:
                $('#detail-status').text('同意了').css('color', '#5cb85c');
                $('.detail-cancel').attr('disabled', true);
                break;
            case 1:
                $('#detail-status').text('还没做出决定').css('color', '#666666');
                $('.detail-cancel').attr('disabled', false);
                break;
            case 3:
                $('#detail-status').text('拒绝了').css('color', '#d9534f');
                $('.detail-cancel').attr('disabled', true);
                break;
        }
        $('#hisdetail').fadeIn(200);
    }

    function backToTable() {
        $('#pagi').show();
        $('#hisdetail').hide();
        $('#plzclick').text('点击查看详情');
        $('#histable').fadeIn(200);
    }
</script>
</body>
</html>